<!DOCTYPE html>
<html>
  <head>
    <title>Game 1234</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" type="text/css" href="/common/css/commonStyles.css" />
    <link rel="stylesheet" type="text/css" href="/common/css/msStyles.css" />
    <style>
      @font-face {
        font-family: "Military RPG";
        src: url("/common/assets/Military_RPG.ttf"); /* seems to need relatove path?!? */
      }
    </style>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="rootDiv" style="position:absolute;width:1275px;height:825px;background-color:rgba(86, 182, 222);">
      <svg width="100%" height="100%" style="padding:10px;box-sizing:border-box;">
        <g id="board" viewBox="0 0 3400 2200">
          <image id="imgMap" width="3400" height="2200" href="/common/assets/TTmap.jpg" />
        </g>
      </svg>

      <div id="troopDisplay" class="popupStyle gridContainer hCenterScreen"></div>
      <!-- <div id="submitButton" class="centerScreen hidden"><button onclick="submitChoice()">Submit</button></div> -->
    </div>
    <div id="logDisplay" style="position:absolute;left:1275px;top:0px;padding:10px;">log display</div>
    <div id="cardDisplay" style="position:absolute;left:0px;top:825px;padding:10px;">card display</div>
    <!-- #endregion html -->

    <!-- #region standard script loading: js-yaml, w3.js, jquery... -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- #endregion panzoom -->
    <!-- #region panzoom -->
    <script src="https://unpkg.com/panzoom@7.1.2/dist/panzoom.min.js"></script>
    <script src="/common/js/panzoom.js"></script>
    <script>
      document.getElementById("imgMap").addEventListener("dblclick", reset); //panzoom setup
      reset();
    </script>
    <!-- #endregion panzoom -->
    <!-- #region: SCRIPTS  -->
    <script src="/common/js/helpers.js"></script>
    <script src="/common/js/MS.js"></script>
    <script src="/common/js/MTree.js"></script>
    <script src="/common/js/MSManager.js"></script>
    <script src="/common/js/MSelection.js"></script>
    <script src="/common/js/MParser.js"></script>
    <script src="/common/js/MScanner.js"></script>
    <!-- #endregion: SCRIPTS  -->

    <!-- #region GLOBALS -->
    <script>
      const playerFaction = "West"; //set desired faction here
      const rootDiv = document.getElementById("rootDiv");
      const board = document.getElementById("board");
      const troopDisplay = document.getElementById("troopDisplay");
      const cardDisplay = document.getElementById("cardDisplay");
      const logDisplay =  document.getElementById("logDisplay");

      var Manager = new MSManager(board, troopDisplay, cardDisplay); // manages all game objects

      var unitCount; //{'Germany': {'Infantry':16,...}} reserve info dictionary, local asset:unit_count.yml
      var powerList; //['Germany',...,'USA']
      var unitList; //['Infantry',...,'Carrier']
      var actionDeck, investmentDeck;
      var serverData; // json structure
      var selectionTree; // selection tree used in automatic selection process
      var Selection; // an MSelection object created to handle navigating selection tree
    </script>
    <!-- #endregion GLOBALS -->

    <!-- #region CORS server communication -->
    <script>
      //var backendServerUrl = "https://tawzz.pythonanywhere.com/"; // public server
      //var backendServerUrl = "https://fetnt.pythonanywhere.com/"; // public server
      var backendServerUrl = "http://localhost:5000/"; //local server
      function sendurl(url, onResponse) {
        url = backendServerUrl + url;
        //console.log("request sent: ", url);
        w3.http(url, function() {
          if (this.readyState == 4 && this.status == 200) {
            onResponse(this.responseText);
          }
        });
      }
      function sendInit(faction, callback) {
        sendurl("init/hotseat/" + faction, callback);
      }
      function sendAction(faction, selectedLabels) {
        let actionval = selectedLabels.flat();

        // should be in originalOrder!
        let currentOrder = actionval.map(x => Manager.getType(x));
        let correctSorting = orderFromTo(actionval, currentOrder, originalOrder);

        let url = "action/" + faction + "/" + correctSorting.join("+");
        sendurl(url, data => processData(data));
      }
    </script>
    <!-- #endregion CORS server communication -->

    <!-- #region setup TODO: create regions from serverData instead of beforehand!!! -->
    <script>
      function loadRegions(objectManager) {
        loadYML("/common/assets/config/map_pos.yml", data => {
          for (const regionName in data) {
            let position = data[regionName];
            objectManager.createRegion(regionName, position);
          }
        });
      }
      function loadCadrePrototypes(objectManager, callback) {
        loadYML("/common/assets/config/unit_count.yml", data => {
          for (const power in data) {
            for (const unit in data[power]) {
              objectManager.createCadrePrototype(power, unit);
            }
          }
          callback(data);
        });
      }
      function setup() {
        Manager.hideCadrePrototypes();
        Manager.createDecks();
        loadRegions(Manager);
        loadCadrePrototypes(Manager, unit_count_dictionary => {
          unitCount = unit_count_dictionary;
          powerList = Object.keys(unitCount);
          unitList = Object.keys(unitCount["Germany"]);

          // let manager know the type of an id 'Germany' or 'Tank'
          powerList.map(x => Manager.createType(x, "power"));
          unitList.map(x => Manager.createType(x, "unit"));

          sendInit(playerFaction, Start); //Start();//
        });
      }
    </script>
    <!-- #endregion setup -->

    <script>
      var serverTree; // action tree from server
      var originalOrder;
      function Start(dataFromServer) {
        processData(dataFromServer);
      }
      function processData(data) {
        serverData = JSON.parse(data);
        console.log(serverData);
        processCreated(serverData.created);
        processUpdated(serverData.updated);
        processRemoved(serverData.removed);
        processAction(serverData.actions);
      }
      function processCreated(createdData) {
        //console.log("*** processing created: ***");
        //console.log('creating: ',createdData);
        let created = createdData;
        for (id in created) {
          let o = created[id];
          switch (o.obj_type) {
            case "action_card":
              Manager.createDeckCard(id, "action_card");
            case "investment_card":
              Manager.createDeckCard(id, "investment_card");
            case "unit":
              //console.log(o, " is unit to be created");
              // place cadre on region
              let power = o.nationality;
              let unit = o.type;
              let cv = o.cv;
              let region = o.tile;
              let visibleToFactions = o.visible.set;
              if (unit === undefined) {
                //console.log("unit type undefined!!!");
              } else {
                Manager.createCadre(id, power, unit, region, cv, visibleToFactions);
              }
              break;
            default:
              //console.log("---");
              break;
          }
        }
        Manager.printObjects()
      }
      function processUpdated(upData) {
        //console.log('*** processing updated: ***');
        //console.log('updating: ',upData);
      }
      function processRemoved(remData) {
        //console.log('*** processing removed: ***');
        //console.log('removing: ',remData);
      }
      function processAction(actionData) {
        //console.log('*** processing actions: ***')
        console.log("actionData:", actionData);
        if (empty(actionData)) return;
        let sActions = JSON.stringify(actionData);
        let serverTree = new MParser(sActions).tree;
        serverTree.print();
        let b = serverTree.branchSample();
        originalOrder = b.map(x => Manager.getType(x));
        let selInfo = Manager.convertActionTree(serverTree);
        Selection = new MSelection(selInfo);
        let idlists = Selection.getChoices();
        Manager.displayChoices(idlists, onObjectSelected);
      }
      function onObjectSelected(ev) {
        let idSelected = evToId(ev);
        let typeSelected = Manager.getType(idSelected);
        let idlist = Manager.getIdParts(idSelected);
        let result = Selection.processSelection(idlist, typeSelected);

        if (result.isCompleted) {
          let selectedLabels = Selection.getSelectedNodeLabels();
          let selectedIds = Manager.transformToIds(selectedLabels);
          Manager.closeSelection(selectedIds);

          sendAction(playerFaction, selectedLabels);
        } else {
          console.log("unselect:", result.idsToUnselect.toString());
          result.idsToUnselect.map(idparts => {
            Manager.undoSelection(idparts);
          });

          // unselect unchose objects that are selected
          let idlists = Selection.getChoices();
          Manager.displayChoices(idlists, onObjectSelected);
        }
      }
      setup();
    </script>
  </body>
</html>
