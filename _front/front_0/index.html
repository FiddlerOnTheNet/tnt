<!DOCTYPE html>
<html>
  <head>
    <title>NEW</title>
    <link rel="shortcut icon" href="#" />
    <title>TNT!</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" type="text/css" href="/common/css/commonStyles.css" />
    <link rel="stylesheet" type="text/css" href="/common/css/msStyles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="/common/js/helpers.js"></script>
    <script src="/common/js/panzoom.js"></script>
    <script src="/common/js/MS.js"></script>
    <script src="/common/js/BoardFactory.js"></script>
    <script src="/common/js/MTree.js"></script>
    <script src="/common/js/MParser.js"></script>
    <script src="/common/js/MScanner.js"></script>
    <script src="/common/js/MSelection.js"></script>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="mainDiv" class="grid-hidefirst">
      <div id="statusDiv" class="div">status</div>
      <div id="selDiv" class="div hidden">
        <svg id="selSvg" class="svg"><g id="selg"></g></svg>
      </div>
      <div id="rootDiv" class="div" style="background-color:rgba(86, 182, 222);">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="boardG" viewBox="0 0 3400 2200">
            <image id="imgMap" width="3400" height="2200" href="/common/assets/TTmap.jpg" />
          </g>
        </svg>
      </div>
      <div id="logDiv" class="div">log display</div>
      <div id="buttonDiv" class="div">
        <button>next player</button>
      </div>
      <div id="cardDisplay" class="div">cards</div>
      <div id="chatWindow" class="div">chat window</div>
    </div>
    <!-- #endregion HTML -->

    <!-- #region functions -->
    <script>
      function send(url) {
        url = backendServerUrl + url;
        msgCounter += 1;
        console.log(msgCounter, "request sent: ", url);
        w3.http(url, function() {
          if (this.readyState == 4 && this.status == 200) {
            processData(this.responseText);
          }
        });
      }
      function processData(str) {
        let data = JSON.parse(str);
        if (data === undefined) {
          console.log("!!!", str, "!!!");
        } else {
          let faction = G.faction;
          let g = G[faction];
          console.log(data);
          //log
          if ("log" in data) {
            G.log.push(data.log);
          }
          //created
          for (id in data.created) {
            g[id] = data.created[id]; //overwride object of have already
          }
          //updated
          for (id in data.updated) {
            //not sure if have to do this really, since possibly no need
            let o = g[id]; //this object should exist since it is being updated!
            //each property of this object should be changed as in data.updated
            let orig = data.updated[id];
            for (prop in orig) {
              o[prop] = orig[prop];
            }
          }
          //removed
          for (id in data.removed) {
            //not sure if should do anything!
            // if (id in g) {
            //   delete g[id];
            // }
          }

          //hier mach sowas wie Presenter.updateUI();
          updateUI();

          //either actions or waiting_for:
          console.log("*** actions starts ***");
          if ("actions" in data) {
            console.log("there are actions!!!! tree:");
            let sActions = JSON.stringify(data.actions);
            let serverTree = new MParser(sActions).tree;
            serverTree.print();
            choiceTuples = getChoices(serverTree);
            console.log("choices", choiceTuples);

            //hier erstmal unique ids >> choicesByType
            for (const choice of choiceTuples) {
              for (const id of choice) {
                if (id in uis) {
                  makeSelectable(uis[id], onSelected);
                } else {
                  console.log(id);
                  let ui = id in selectables ? selectables[id] : addSelectable(id);
                  makeSelectable(ui);
                }
              }
            }
          } else {
            console.log(data.waiting_for, "will change turn!!!");
          }
        }
        console.log(G);
        console.log("_____________");
        //settings = {any_kind_of_object: true};
        //json_str = JSON.stringify(G);
        //saveFile("yourfilename.json", "data:application/json", new Blob([json_str], {type: ""}));
      }
      function onSelected(ev) {
        let id = evToId(ev);
        console.log(id, " selected!");
      }
      function makeSelectable(ms, handler) {

        ms.highlight();
        ms.isEnabled = true;
        //console.log(handler)
        ms.clickHandler = handler;
      }

      function openSelectionIfPopulated() {
        let d = document.getElementById("selDiv");
        if (d.style.display != "none") return;
        for (const key in choicesByType) {
          for (const id of choicesByType[key]) {
            if (id in selectables) {
              let dMain = document.getElementById("mainDiv");
              dMain.classList.remove("grid-hidefirst");
              dMain.classList.add("grid-container");
              d.classList.remove("hidden");
              console.log(id);
              return;
            }
          }
        }
      }
      function closeSelection() {
        let d = document.getElementById("selDiv");
        if (d.style.display == "none") return;
        let dMain = document.getElementById("mainDiv");
        dMain.classList.add("grid-hidefirst");
        dMain.classList.remove("grid-container");
        d.classList.add("hidden");
      }
      function addSelectable(id) {
        //add a simple selectable object to selectables area selDiv
        // <div id='selDiv' class="div" style="display:none"><svg id='selSvg' class='svg'><g id='selg'></g></svg></div>
        let d = document.getElementById("selDiv");
        let g = document.getElementById("selG");
        let sz = SZ.cadreDetail;
        let ms = undefined;
        if (G["nationality"].includes(id)) {
          ms = new MS(id, g).roundedRect({w: sz, h: sz, fill: troopColors[id], rounding: sz * 0.1})
          .roundedRect({className: "overlay region hible selectable", w: sz, h: sz, rounding: sz * 0.1});
          ms.tag("type", "nationality");
          console.log(id);
          selectables[id] = ms;
        } else if (G["unit_type"].includes(id)) {
          ms = new MS(id, g)
            .roundedRect({w: sz, h: sz, fill: "black", rounding: sz * 0.1})
            .image({w: sz, h: sz, path: "/_front/assets/images/" + id + ".svg", rounding: sz * 0.1})
            .roundedRect({className: "overlay region hible selectable", w: sz, h: sz, rounding: sz * 0.1});

          ms.tag("type", "unit_type");
          console.log(id);
          selectables[id] = ms;
        }
        return ms;
        //object type will get from G[]
      }
      function lineupSelectables(type, ids) {
        let gap = 10;
        let x = 10;
        let y = 10;
        let sz = SZ.cadreDetail;
        for (const id of ids) {
          if (!(id in selectables)) {
            console.log(id, " not in selectables!");
            return;
          }
          let ms = selectables[id];
          ms.setPos(x, y).draw();
          y += gap + sz;
        }
      }
      function getChoices(tree) {
        let branchlist = tree.branchlist();
        // branchlist = branchlist.map(l => l.slice(0, branchlen));
        branchlist = branchlist.map(b => cartesianOf(b)).flat();
        branchlist = branchlist.map(s => s.split("_"));
        //console.log(branchlist[0].toString());
        return branchlist;
      }
      function updateUI() {
        //have to know how to create an object of type: obj_type
        //example: create a tile object
        //console.log("*** starting to process ***");
        var currentFaction = G.faction;
        var currentView = G[currentFaction];
        for (id in currentView) {
          let go = currentView[id];
          let ttext = JSON.stringify(go);
          //console.log(go.obj_type);
          if (!(id in uis)) {
            //create object with immutable properties (mutable properties in update)
            switch (go.obj_type) {
              case "tile":
                //console.log("create region", id);
                uis[id] = boardFactory.createTile(id, ttext);
                //muss noch die units placen! irgendwie irgendwann!
                break;
              case "unit":
                //console.log("create unit", id);
                uis[id] = boardFactory.createUnit(id, go.nationality, go.type, ttext);
                break;
            }
          }
        }
        for (id in currentView) {
          let go = currentView[id];
          //update properties
          let ui = uis[id];
          for (prop in go) {
            //map values of property to ui
            switch (prop) {
              case "tile":
                //make sure this is a cadre
                if (go.obj_type != "unit") {
                  console.log("trying to place a", go.obj_type);
                }
                let tile = go[prop];
                //console.log(tile,go)
                let uiTile = uis[tile];
                boardFactory.placeUnit(ui, tile, uiTile, currentFaction);
                break;
              case "cv":
                //make sure this is a cadre
                if (go.obj_type != "unit") {
                  console.log("trying to attach cv to ", go.obj_type);
                }
                let cv = go[prop];
                //console.log(cv,go)
                boardFactory.updateCv(ui, cv);
                break;
            }
          }
          //update visibility
        }

        //test area
        //darkerColor(255,255,0);
        //each object after creation has a
      }
    </script>
    <!-- #endregion functions -->

    <!-- #region setup -->
    <script>
      var G = {Axis: {}, West: {}, USSR: {}, log: [], faction: "West"};
      var uis = {}; //by id
      var selectables = {}; // by id, parts like "Germany" or "Infantry"

      var choiceTuples = []; // all tuples in a selection action
      var choicesByType = {};
      var selectedids = {}; // by type, depending on tuples to select, one list for each tuple component

      var backendServerUrl = "http://localhost:7777/"; //local server
      var msgCounter = 0;

      const board = document.getElementById("boardG");

      board.setAttribute("transform", `translate(-400,-400) scale(${1})`);
      board.addEventListener("wheel", ev => {
        onwheel(ev, board);
      });
      board.addEventListener("pointerdown", ev => {
        onmousedown(ev);
      });
      addEventListener("mouseup", ev => {
        onmouseup(ev, board);
      });
      addEventListener("mousemove", ev => {
        onmousemove(ev, board);
      });
      addEventListener("dblclick", ev => reset(ev, board));

      var boardFactory = null;

      //*** execution starts here ***
      loadYML("/common/assets/config/map_pos.yml", data => {
        boardFactory = new BoardFactory(board, data);
        loadYML("/common/assets/config/unit_count.yml", data => {
          G["unitCount"] = data;
          G["nationality"] = Object.keys(data); //'Germany','Britain',...
          G["unit_type"] = Object.keys(data["Germany"]); //'Infantry','Tank'...
          send("init/hotseat/" + G.faction);
        });
      });
    </script>
    <!-- #endregion setup -->
  </body>
</html>
